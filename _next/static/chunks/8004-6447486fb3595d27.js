"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8004],{66779:function(e,n,t){t.d(n,{G5:function(){return m},UB:function(){return p},Ve:function(){return h},Wn:function(){return b},bD:function(){return x},kJ:function(){return v},rM:function(){return f}});var i=t(7297),o=t(75063);function r(){var e=(0,i.Z)(['\n  query GetFinancialJob(\n    $adminId: Int\n    $customerId: Int\n    $endDate: timestamptz\n    $startDate: timestamptz\n    $limit: Int\n    $status: [String]\n    $managerId: Int\n    $locationId: Int\n    $offset: Int\n    $supplierId: Int\n    $q: String\n    $orderBy: Job_order_by!\n  ) {\n    jobs: Job(\n      limit: $limit\n      offset: $offset\n      where: {\n        type: { _in: ["reactive", "ppm"] }\n        _and: [\n          {\n            _or: [\n              { reference: { _ilike: $q } }\n              { title: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { Invoices: { invoiceNumber: { _ilike: $q } } }\n            ]\n          }\n          {\n            _or: [\n              { _and: [{ timingStart: { _gte: $startDate } }, { timingStart: { _lte: $endDate } }] }\n              { _and: [{ scheduledAt: { _gte: $startDate } }, { scheduledAt: { _lte: $endDate } }] }\n            ]\n          }\n        ]\n        status: { _in: $status }\n        customerId: { _eq: $customerId }\n        supplierId: { _eq: $supplierId }\n        managerId: { _eq: $managerId }\n        adminId: { _eq: $adminId }\n        locationId: { _eq: $locationId }\n      }\n      order_by: [$orderBy]\n    ) {\n      id\n      type\n      number\n      status\n      description\n      reference\n      timingStart\n      scheduledAt\n      createdAt\n\n      customerTotal: customerFinances(path: "amountInfo.total")\n      supplierTotal: supplierFinances(path: "amountInfo.total")\n      customerVatTotal: customerFinances(path: "amountInfo.vatTotal")\n      supplierVatTotal: supplierFinances(path: "amountInfo.vatTotal")\n      customerExpensesTotal: customerFinances(path: "expensesInfo.expensesTotal")\n      supplierExpensesTotal: supplierFinances(path: "expensesInfo.expensesTotal")\n      customerRebateAmount: customerFinances(path: "rebate.amount")\n\n      slaId\n      invoices: Invoices(order_by: { createdAt: desc }) {\n        invoiceNumber\n      }\n      customer: Customer {\n        id\n        name\n      }\n      supplier: Supplier {\n        id\n        name\n      }\n      location: Location {\n        id\n        name\n      }\n      sublocation: Sublocation {\n        id\n        name\n      }\n      sla: SLA {\n        name\n      }\n      manager: Manager {\n        fullName\n        nameLast\n        nameFirst\n        id\n      }\n      service: Service {\n        id\n        name\n      }\n    }\n    meta: Job_aggregate(\n      where: {\n        type: { _in: ["reactive", "ppm"] }\n        _and: [\n          {\n            _or: [\n              { reference: { _ilike: $q } }\n              { title: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { Invoices: { invoiceNumber: { _ilike: $q } } }\n            ]\n          }\n          {\n            _or: [\n              { _and: [{ timingStart: { _gte: $startDate } }, { timingStart: { _lte: $endDate } }] }\n              { _and: [{ scheduledAt: { _gte: $startDate } }, { scheduledAt: { _lte: $endDate } }] }\n            ]\n          }\n        ]\n        status: { _in: $status }\n        customerId: { _eq: $customerId }\n        supplierId: { _eq: $supplierId }\n        managerId: { _eq: $managerId }\n        adminId: { _eq: $adminId }\n        locationId: { _eq: $locationId }\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n']);return r=function(){return e},e}function a(){var e=(0,i.Z)(['\n  query GetCustomers(\n    $customerManagerId: Int\n    $date: timestamptz\n    $limit: Int\n    $offset: Int\n    $q: String\n    $orderBy: Account_order_by!\n    $status: String\n  ) {\n    customers: Account(\n      limit: $limit\n      offset: $offset\n      where: {\n        type: { _eq: "customer" }\n        createdAt: { _eq: $date }\n        managerId: { _eq: $customerManagerId }\n        name: { _ilike: $q }\n        status: { _eq: $status }\n      }\n      order_by: [$orderBy]\n    ) {\n      id\n      createdAt\n      name\n      companyNumber\n      vatId\n      website\n      status\n      addresses: Addresses(where: { entity: { _eq: "Account" } }) {\n        id\n        registered\n        operating\n        trading\n        invoice\n        status\n        createdAt\n        address: Address {\n          id\n          name\n          addressLine1\n          addressLine2\n          addressLine3\n          city\n          county\n          geo\n          postCode\n          country: Country {\n            id\n            name\n          }\n        }\n      }\n      locations: Account_Locations {\n        id\n      }\n      finance: Financial {\n        id\n        invoicing\n        serviceRate\n        stripeId\n        totalRevenue\n        unpaidInvoices\n        creditLimit\n        creditRating\n        createdAt\n        amountOutstanding\n        accountId\n        approvalThreshold\n        arrangementFee\n        spendThreshold\n        defaultPaymentMethod\n      }\n      manager: Manager {\n        id\n        nameFirst\n        nameLast\n      }\n      contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n        id\n        role\n        position\n        isContact\n        lastSignInAt\n        userId\n        user: User {\n          id\n          name: nameFirst\n          nameFirst\n          nameLast\n          phone\n          status\n          email\n          createdAt\n          fullName\n          accounts: Account_Users {\n            id\n            role\n            position\n            isContact\n            status\n            account: Account {\n              id\n              name\n              type\n            }\n          }\n        }\n      }\n    }\n    meta: Account_aggregate(\n      where: {\n        type: { _eq: "customer" }\n        createdAt: { _eq: $date }\n        managerId: { _eq: $customerManagerId }\n        name: { _ilike: $q }\n        status: { _eq: $status }\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n']);return a=function(){return e},e}function c(){var e=(0,i.Z)(['\n  query GetCustomer($id: Int!) {\n    customer: Account_by_pk(id: $id) {\n      id\n      name\n      clientType: ClientType {\n        id\n        name\n      }\n      structure\n      companyNumber\n      vatId\n      website\n      status\n      createdAt\n      updatedAt\n      status\n      type\n      meta\n      usersMeta: Account_Users_aggregate {\n        aggregate {\n          count\n        }\n      }\n      propertiesMeta: Account_Locations_aggregate {\n        aggregate {\n          count\n        }\n      }\n      jobsMeta: CustomerJobs_aggregate {\n        aggregate {\n          count\n        }\n      }\n      addresses: Addresses(where: { entity: { _eq: "Account" } }) {\n        id\n        registered\n        operating\n        trading\n        invoice\n        status\n        createdAt\n        address: Address {\n          id\n          name\n          addressLine1\n          addressLine2\n          addressLine3\n          city\n          county\n          geo\n          postCode\n          country: Country {\n            id\n            name\n          }\n        }\n      }\n      manager: Manager {\n        id\n        nameFirst\n        nameLast\n        phone\n        email\n      }\n      contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n        id\n        role\n        position\n        isContact\n        lastSignInAt\n        userId\n        user: User {\n          id\n          name: nameFirst\n          nameFirst\n          nameLast\n          phone\n          status\n          email\n          createdAt\n          fullName\n          accounts: Account_Users {\n            id\n            role\n            position\n            isContact\n            status\n            account: Account {\n              id\n              name\n              type\n            }\n          }\n        }\n      }\n      bankAccounts: BankAccounts {\n        id\n        stripeId\n        accountNumber\n        routingNumber\n        bic\n        iban\n        status\n        default\n        createdAt\n      }\n      media: Media {\n        id\n        medium: Medium {\n          id\n          category\n          filename\n          meta\n          type\n        }\n      }\n      cards: Cards {\n        id\n        stripeId\n        type\n        last4\n        expYear\n        expMonth\n        status\n        default\n        createdAt\n      }\n      jobs: CustomerJobs {\n        id\n        title\n      }\n      finance: Financial {\n        id\n        invoicing\n        serviceRate\n        stripeId\n        totalRevenue\n        unpaidInvoices\n        creditLimit\n        creditRating\n        createdAt\n        amountOutstanding\n        accountId\n        approvalThreshold\n        arrangementFee\n        spendThreshold\n        defaultPaymentMethod\n      }\n      accountEntries: AccountEntries(order_by: { createdAt: asc }) {\n        id\n        outstandingAmount\n        type\n        entryId\n        currencyId\n        createdAt\n        balance\n        amount\n        accountId\n        updatedAt\n      }\n    }\n  }\n']);return c=function(){return e},e}function u(){var e=(0,i.Z)(["\n  query GetCustomerManage($id: Int!) {\n    customer: Account_by_pk(id: $id) {\n      id\n      name\n      website\n      companyNumber\n      vatId\n      meta\n      contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n        id\n        isContact\n        userId\n        user: User {\n          id\n          email\n          fullName\n          meta\n          name: nameFirst\n          nameFirst\n          nameLast\n          phone\n          status\n        }\n      }\n      clientType: ClientType {\n        id\n        label: name\n        value: id\n      }\n      status\n      managerSelected: Manager {\n        id\n        label: fullName\n        value: id\n      }\n    }\n  }\n"]);return u=function(){return e},e}function d(){var e=(0,i.Z)(["\n  mutation AddCustomer($objects: [Account_insert_input!]!) {\n    insert_Account(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]);return d=function(){return e},e}function s(){var e=(0,i.Z)(["\n  mutation UpdateCustomer(\n    $customerId: Int!\n    $customer: Account_set_input\n    $userId: Int!\n    $user: User_set_input\n    $hasUpdateUser: Boolean!\n  ) {\n    update_Account_by_pk(pk_columns: { id: $customerId }, _set: $customer) {\n      id\n    }\n    update_User_by_pk(pk_columns: { id: $userId }, _set: $user) @include(if: $hasUpdateUser) {\n      id\n    }\n  }\n"]);return s=function(){return e},e}function l(){var e=(0,i.Z)(["\n  mutation AddFinancial($objects: [Financial_insert_input!]!) {\n    insert_Financial(objects: $objects) {\n      returning {\n        id\n        accountId\n        locationId\n      }\n    }\n  }\n"]);return l=function(){return e},e}var m=(0,o.Ps)(r()),v=(0,o.Ps)(a()),p=(0,o.Ps)(c()),f=(0,o.Ps)(u()),h=(0,o.Ps)(d()),b=(0,o.Ps)(s()),x=(0,o.Ps)(l())},8052:function(e,n,t){t.d(n,{y:function(){return D}});var i=t(26042),o=t(85893),r=t(45697),a=t(68956),c=t(26186),u=t(16551),d=t(77439),s=t(11585),l=t(16540),m=t(47568),v=t(69396),p=t(828),f=t(97582),h=t(50319),b=t(7297),x=t(75063);function y(){var e=(0,b.Z)(["\n  mutation AddBankAccount($objects: [BankAccount_insert_input!]!) {\n    insert_BankAccount(objects: $objects) {\n      returning {\n        id\n        stripeId\n        accountNumber\n        routingNumber\n        bic\n        iban\n        status\n        createdAt\n      }\n    }\n  }\n"]);return y=function(){return e},e}function g(){var e=(0,b.Z)(["\n  mutation UpdateBankAccount($id: Int!, $changes: BankAccount_set_input) {\n    update_BankAccount_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n"]);return g=function(){return e},e}var I=(0,x.Ps)(y()),j=(0,x.Ps)(g()),Z=t(42283),_=t(79665),w=t(76600),C=t(49501),T=t(55563),R=t(58594),N=t(74231),S=(0,N.Ry)().shape({bank:(0,N.Z_)().required(),accountNumber:(0,N.Z_)().required(),bic:(0,N.Z_)().required(),iban:(0,N.Z_)().required(),routingNumber:(0,N.Z_)().required()}),A=function(e){var n,t=e.accountId,r=e.data,a=e.refetch,c=e.toggleShow,u=(0,Z.cI)({defaultValues:r,resolver:(0,_.S)(S)}),d=u.errors,s=u.handleSubmit,l=u.register,b=(0,p.Z)((0,h.D)(I,{onCompleted:function(){a()}}),1)[0],x=(0,p.Z)((0,h.D)(j,{onCompleted:function(){a()}}),1)[0],y=(n=(0,m.Z)(function(e){var n;return(0,f.__generator)(this,function(o){switch(o.label){case 0:if((n=(0,i.Z)({},e)).stripeId="ba_42g2s45sh46jl46h",n.accountId=t,n.status="active",n.countryId=1,n.currencyId=1,n.meta={showInInvoice:Boolean(n.showInInvoice)},delete n.showInInvoice,!(null==r?void 0:r.id))return[3,1];return x({variables:{id:r.id,changes:n}}),[3,3];case 1:return[4,b({variables:{objects:[n]}})];case 2:o.sent(),o.label=3;case 3:return c(),[2]}})}),function(e){return n.apply(this,arguments)}),g={errors:d,register:l};return(0,o.jsxs)(w.Z,{id:"offCanvasForm",handleSubmit:s(y),children:[(0,o.jsx)(C.Z,{label:"Bank name",children:(0,o.jsx)(T.Z,(0,v.Z)((0,i.Z)({},g),{name:"bank"}))}),(0,o.jsx)(C.Z,{label:"Account number",children:(0,o.jsx)(T.Z,(0,v.Z)((0,i.Z)({},g),{name:"accountNumber"}))}),(0,o.jsx)(C.Z,{label:"Routing number",children:(0,o.jsx)(T.Z,(0,v.Z)((0,i.Z)({},g),{name:"routingNumber"}))}),(0,o.jsx)(C.Z,{label:"BIC",children:(0,o.jsx)(T.Z,(0,v.Z)((0,i.Z)({},g),{name:"bic"}))}),(0,o.jsx)(C.Z,{label:"IBAN",children:(0,o.jsx)(T.Z,(0,v.Z)((0,i.Z)({},g),{name:"iban"}))}),(0,o.jsx)(R.Z,(0,v.Z)((0,i.Z)({},g),{data:[{id:"1",label:"Show in invoice",value:"true"}],name:"showInInvoice"}))]})};A.propTypes={accountId:r.number,toggleShow:r.func,updateRows:r.func};var k=t(64872),D=function(e){var n=e.accountId,t=e.data,r=e.edit,m=e.refetch,v=(0,k.a)(),p=[{hidden:!0},{text:"Bank"},{text:"Account number"},{text:"Routing"},{text:"BIC"},{text:"IBAN"},{text:"Stripe ID",hidden:!0},{text:"Date Added"},{formatter:function(e){return!0===e.row.showInInvoice?"True":"False"},text:"Show In Invoice"},{formatter:a.Z,formatterData:[{context:"secondary",icon:["fas","edit"],onClick:function(e,n){return b(e,n)},tooltip:"Edit"}],text:"Actions"}],f=function(e){var n,t;return{id:e.id,bank:null==e?void 0:e.bank,accountNumber:null==e?void 0:e.accountNumber,routingNumber:null==e?void 0:e.routingNumber,bic:null==e?void 0:e.bic,iban:null==e?void 0:e.iban,stripeId:e.stripeId,date:(0,c.Z)(e.createdAt),showInInvoice:null!==(n=e.meta)&&void 0!==n&&!!n.showInInvoice&&(null===(t=e.meta)||void 0===t?void 0:t.showInInvoice),actions:""}},h=function(e){e.stopPropagation(),v.show({content:(0,o.jsx)(A,{accountId:n,refetch:m,toggleShow:v.close}),title:"Add Bank Account"})},b=function(e,t){e.stopPropagation(),v.show({content:(0,o.jsx)(A,{accountId:n,data:(0,i.Z)({},t)||{},refetch:m,toggleShow:v.close}),title:"Add Bank Account"})},x=function(){return(0,o.jsx)(u.Z,{children:(0,o.jsx)(d.Z,{context:"secondary",content:"Add",onClick:h,size:"sm"})})};return(0,o.jsx)(s.Z,{open:!0,title:"Bank Accounts",toolbar:r&&(0,o.jsx)(x,{}),children:(0,o.jsx)(l.Z,{columns:p,rows:t.map(function(e){return f(e)})})})};D.propTypes={data:r.array},D.defaultProps={data:[],edit:!0}},45082:function(e,n,t){t.d(n,{r:function(){return i}});var i=[{text:"All work orders",value:null,label:"All work orders"},{text:"All outstanding invoices",value:"0-",label:"All outstanding invoices"},{text:"1 - 30",value:"1-30",label:"1 - 30"},{text:"31 - 60",value:"31-60",label:"31 - 60"},{text:"61 - 90",value:"61-90",label:"61 - 90"},{text:"> 90",value:"90-",label:"> 90"}]},59577:function(e,n,t){t.d(n,{b:function(){return nb}});var i={};t.r(i),t.d(i,{y:function(){return ey},I:function(){return eg}});var o=t(47568),r=t(97582),a=t(85893),c=t(67294),u=t(45697),d=t(11163),s=t(6812),l=t(26695),m=t(78289),v=t(11082),p=t(16551),f=t(77439),h=t(9270),b=t(62140),x=t(11585),y=t(16540),g=t(8052),I=t(7297),j=t(10367),Z=t(86036),_=t(55377),w=t(11587),C=t(25742),T=t(35418),R=t(26042),N=t(69396),S=t(828),A=t(50319),k=t(66779),D=t(42283),q=t(76600),P=t(28497),$=t(49501),E=t(55563),F=function(e){var n,t=e.accountId,i=e.meta,c=e.refetch,u=e.toggleShow,d=(0,R.Z)({},null==i?void 0:i.finance)||{},s=(0,D.cI)({defaultValues:{creditLimit:d.creditLimit||0,creditRating:d.creditRating||0}}),l=s.errors,m=s.handleSubmit,v=s.register,p=(0,S.Z)((0,A.D)(k.Wn),1)[0],f=(n=(0,o.Z)(function(e){return(0,r.__generator)(this,function(n){return p({variables:{customerId:t,customer:h(e)}}).then(function(){c(),u()}),[2]})}),function(e){return n.apply(this,arguments)}),h=function(e){var n={};return n.meta=(0,R.Z)({},i)||{},n.meta.finance=d||{},n.meta.finance.creditLimit=Number(e.creditLimit),n.meta.finance.creditRating=Number(e.creditRating),n},b={errors:l,register:v};return(0,a.jsxs)(q.Z,{id:"offCanvasForm",handleSubmit:m(f),children:[(0,a.jsx)(P.Z,(0,N.Z)((0,R.Z)({},b),{name:"creditLimit",label:"Credit Limit"})),(0,a.jsx)($.Z,{label:"Credit Rating",children:(0,a.jsx)(E.Z,(0,N.Z)((0,R.Z)({},b),{name:"creditRating",type:"number"}))})]})};F.propTypes={finance:u.object.isRequired,refetch:u.func.isRequired,toggleShow:u.func.isRequired};var L=function(e){var n=e.percent,t=e.breakPoints;return((!t||t.length<2)&&(t=[70,90]),n<=t[0])?"success":n<=t[1]?"warning":"danger"},M=t(97432);function B(){var e=(0,I.Z)(["\n  margin-bottom: 0;\n"]);return B=function(){return e},e}var J=function(e){var n,t,i=e.accountId,o=e.edit,r=e.meta,c=e.offCanvas,u=e.customerBalance,d=e.refetch,s=(null==r?void 0:r.finance)||{};n=!(u>=0)&&(null==s?void 0:s.creditLimit)?-1*(0,M.l)(u/(null==s?void 0:s.creditLimit)*100,0):0;var l=function(){c.show({title:"Edit Credit Details",content:(0,a.jsx)(F,{accountId:i,meta:r,refetch:d,toggleShow:c.close})})};return(0,a.jsxs)(T.G,{carousel:!1,details:!0,entity:"CreditReport",entityId:null==s?void 0:s.id,summary:"Credit Report",children:[(0,a.jsx)(Z.Z,{content:"Balance",text:(0,v.Z)(null!=u?u:0)}),(0,a.jsx)(Z.Z,{content:"Credit Limit",text:(0,a.jsxs)(a.Fragment,{children:["".concat((0,v.Z)(null!==(t=null==s?void 0:s.creditLimit)&&void 0!==t?t:0)," "),(0,a.jsx)(W,{size:"sm",content:"".concat(n,"%"),context:L({percent:n})})]})}),(0,a.jsx)(Z.Z,{content:"Credit Rating",text:(null==s?void 0:s.creditRating)||0}),o&&(0,a.jsx)(C.H,{content:"Edit",handleClick:l}),(0,a.jsx)(_.Z,{size:"sm"})]})};J.defaultProps={edit:!0};var W=(0,j.ZP)(w.Z).withConfig({displayName:"creditReport__StyledBadge",componentId:"sc-e5cfbb1e-0"})(B()),U=t(66252),X=t(73359),Y=t(57460),z=t.n(Y),O=t(45416),V=t(2845),Q=t(98552),G=t(86532),K=t(22797),H=t(38895),ee=t(15861),en=t(51233),et=t(84808),ei=t(98456),eo=t(15033),er=t(40876),ea=t(30381),ec=t.n(ea),eu=t(75832),ed=t(1691),es=t(11057),el=t(18586),em=t(75759),ev=t(39641),ep=function(e){var n,t,i,o,r=e.accountEntryId,u=e.close,d=(0,ev.D)(),m=(0,el.q)(),v=null===(n=m.admin)||void 0===n?void 0:null===(t=n.jobSetting)||void 0===t?void 0:t.jobNumberPrefix,p=null===(i=m.admin)||void 0===i?void 0:null===(o=i.jobSetting)||void 0===o?void 0:o.jobNumberSuffix,f=(0,(0,V.x)().hasRole)("admin"),h=(0,S.Z)((0,A.D)(l.Y8,{refetchQueries:["GetAccountEntries"],onCompleted:function(){d.show({content:"Account Entry was successfully deleted",severity:"success"}),u&&u()},onError:function(e){d.show({content:"Error: ".concat(e.message),severity:"error"})}}),2),b=h[0],x=h[1].loading,y=(0,s.a)(l.L2,{variables:{accountEntryId:r}}),g=y.data,I=(void 0===g?{accountEntry:{}}:g).accountEntry,j=y.loading,Z=(0,s.a)(l.to,{variables:{accountEntryId:I.id,skip:!I.id||!["paymentReceipt","creditNote"].includes(I.type)}}),_=Z.data,w=(void 0===_?{reconciliations:[]}:_).reconciliations,C=Z.loading,T=(0,s.a)(l.yz,{variables:{accountEntryId:I.id,skip:!I.id||!Q.YK.includes(I.type)}}),R=T.data,N=(void 0===R?{invoices:[]}:R).invoices,k=T.loading,D=(0,c.useMemo)(function(){return w.map(function(e){var n,t,i,o,r,a=null===(n=e.accountEntryInvoice)||void 0===n?void 0:null===(t=n.invoices)||void 0===t?void 0:t[0];return Q.YK.includes(e.type)?{id:e.id,jobNumber:null,invoiceNumber:e.accountEntryInvoice.invoiceNumber,invoiceType:e.accountEntryInvoice.type,date:ec()(e.createdAt).format("YYYY-MM-DD"),reconciledAmount:(0,eu.T)(e.amount),jobType:"ppm",jobId:null}:{id:e.id,jobNumber:null==a?void 0:null===(i=a.job)||void 0===i?void 0:i.number,invoiceNumber:null==a?void 0:a.invoiceNumber,invoiceType:null==a?void 0:a.invoiceType,date:ec()(e.createdAt).format("YYYY-MM-DD"),reconciledAmount:(0,eu.T)(e.amount),jobType:null==a?void 0:null===(o=a.job)||void 0===o?void 0:o.type,jobId:null==a?void 0:null===(r=a.job)||void 0===r?void 0:r.id}})},[w]),q=(0,c.useMemo)(function(){return N.map(function(e){var n,t,i,o;return{id:null==e?void 0:null===(n=e.Job)||void 0===n?void 0:n.id,number:null==e?void 0:null===(t=e.Job)||void 0===t?void 0:t.number,status:null==e?void 0:null===(i=e.Job)||void 0===i?void 0:i.status,invoiceNumber:null==e?void 0:e.invoiceNumber,jobType:null==e?void 0:null===(o=e.Job)||void 0===o?void 0:o.type}})},[N]),P=function(e){e.stopPropagation(),b({variables:{id:I.id}})};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(et.Z,{sx:{zIndex:1e5},open:j||x,children:(0,a.jsx)(ei.Z,{color:"secondary"})}),(0,a.jsxs)(G.Z,{defaultExpanded:!0,children:[(0,a.jsx)(H.Z,{expandIcon:(0,a.jsx)(er.Z,{}),children:"Account Entry Details"}),(0,a.jsx)(K.Z,{children:(0,a.jsxs)(en.Z,{spacing:1,children:[(0,a.jsxs)(en.Z,{children:[(0,a.jsx)(ee.Z,{variant:"subtitle2",children:"Date"}),(0,a.jsx)(ee.Z,{children:ec()(I.createdAt).format("YYYY-MM-DD")})]}),(0,a.jsxs)(en.Z,{children:[(0,a.jsx)(ee.Z,{variant:"subtitle2",children:"Type"}),(0,a.jsx)(ee.Z,{children:I.type})]}),(0,a.jsxs)(en.Z,{children:[(0,a.jsx)(ee.Z,{variant:"subtitle2",children:"Reference"}),(0,a.jsx)(ee.Z,{children:I.reference||"-"})]}),(0,a.jsxs)(en.Z,{children:[(0,a.jsx)(ee.Z,{variant:"subtitle2",children:"Comment"}),(0,a.jsx)(ee.Z,{children:I.comment||"-"})]}),(0,a.jsxs)(en.Z,{children:[(0,a.jsx)(ee.Z,{variant:"subtitle2",children:"Debit"}),(0,a.jsx)(ee.Z,{children:(0,eu.T)(I.debit)})]}),(0,a.jsxs)(en.Z,{children:[(0,a.jsx)(ee.Z,{variant:"subtitle2",children:"Credit"}),(0,a.jsx)(ee.Z,{children:(0,eu.T)(I.credit)})]})]})})]}),["paymentReceipt","creditNote"].includes(I.type)&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(G.Z,{defaultExpanded:!0,children:[(0,a.jsx)(H.Z,{expandIcon:(0,a.jsx)(er.Z,{}),children:"Related Invoices"}),(0,a.jsx)(K.Z,{children:(0,a.jsx)(eo.i,{loading:C,columns:[{flex:1,sortable:!1,headerName:"Number",field:"jobNumber",renderCell:function(e){var n=e.row;return Q.YK.includes(n.invoiceType)?"PM ".concat(n.invoiceNumber):(0,a.jsx)(O.D,{id:n.jobId,number:n.jobNumber,invoiceNumber:n.invoiceNumber,numberPrefix:v,numberSuffix:p,openCanvas:!0,type:n.jobType})}},{flex:1,sortable:!1,headerName:"Date",field:"date"},{flex:1,sortable:!1,headerName:"Reconciled Amount",field:"reconciledAmount"}],rows:D})})]}),f&&(0,a.jsx)(es.Z,{fullWidth:!0,variant:"contained",color:"danger",sx:{marginTop:"16px"},onClick:P,children:"Delete"}),f&&w.length>0&&(0,a.jsx)(ed.Z,{variant:"filled",severity:"info",sx:{marginTop:"16px"},children:"Deleting this receipt will potentially remove other reconciled entries."})]}),Q.YK.includes(I.type)&&(0,a.jsxs)(G.Z,{defaultExpanded:!0,children:[(0,a.jsx)(H.Z,{expandIcon:(0,a.jsx)(er.Z,{}),children:"Related Jobs"}),(0,a.jsx)(K.Z,{children:(0,a.jsx)(eo.i,{loading:k,columns:[{flex:1,sortable:!1,headerName:"Number",field:"number",renderCell:function(e){var n=e.row;return(0,a.jsx)(O.D,{id:n.id,number:n.number,invoiceNumber:n.invoiceNumber,numberPrefix:v,numberSuffix:p,openCanvas:!0,type:n.jobType,close:function(){u&&u()}})}},{flex:1,sortable:!1,headerName:"Status",field:"status",renderCell:function(e){var n=e.row;return n.status?(0,a.jsx)(em.B,{value:n.status}):""}}],rows:q})})]})]})};ep.propTypes={accountEntryId:u.number,close:u.func},ep.defaultProps={};var ef=t(29815),eh=t(74297),eb=t(26186),ex=t(79033),ey=function(e,n){var t=n||{},i=t.numberPrefix,o=void 0===i?"":i,r=t.numberSuffix,a=void 0===r?"":r;return e.map(function(e){var n,t,i,r,c,u,d,s,l,m,v,p,f,h,b,x,y=(null==e?void 0:null===(n=e.reconciliations)||void 0===n?void 0:null===(t=n.aggregate)||void 0===t?void 0:null===(i=t.sum)||void 0===i?void 0:i.amount)||null,g=null===(r=e.invoices)||void 0===r?void 0:r[0],I=null;return["invoice","proformaInvoice"].includes(e.type)?I="".concat((0,ex.y)(null==g?void 0:null===(b=g.Job)||void 0===b?void 0:b.type)," ").concat(o," ").concat(null==g?void 0:null===(x=g.Job)||void 0===x?void 0:x.number," ").concat(a," / ").concat(null==g?void 0:g.invoiceNumber):Q.YK.includes(e.type)&&(I="PM / ".concat((null==g?void 0:g.invoiceNumber)||"")),{itemType:(0,eh.Z)(e.type),invoice:I,reference:(null===(c=e.meta)||void 0===c?void 0:c.paymentReference)||(null==g?void 0:null===(u=g.Job)||void 0===u?void 0:u.reference),date:(0,eb.Z)(e.createdAt),daysOutstanding:null==e?void 0:e.outstandingdays,status:null==g?void 0:null===(d=g.Job)||void 0===d?void 0:d.status,service:null==g?void 0:null===(s=g.Job)||void 0===s?void 0:null===(l=s.service)||void 0===l?void 0:l.name,address:null==g?void 0:null===(m=g.Job)||void 0===m?void 0:null===(v=m.location)||void 0===v?void 0:v.name,sublocation:null==g?void 0:null===(p=g.Job)||void 0===p?void 0:null===(f=p.sublocation)||void 0===f?void 0:f.name,debit:e.debit,credit:e.credit,balance:e.balance,reconciledAmount:null!=y?y:0,amountOutstanding:e.outstandingAmount,paymentStatus:e.paymentStatus,comment:null===(h=e.meta)||void 0===h?void 0:h.comment}})},eg=function(e){var n=e.accountId,t=e.from,i=void 0===t?null:t,o=e.jobNumber,r=e.locationId,a=e.outstandingLevel,c=e.to,u=void 0===c?null:c,d=e.type,s=e.invoicesForJobOnly,l={},m={},v=[],p=[],f=[];return r&&(v=[{_or:[{locationId:{_eq:r}},{PaymentReconciliations:{locationId:{_eq:r}}}]}]),d&&(l.type={_in:(0,ef.Z)(d).concat(["ppmInvoice","invoice"])},l.paymentStatus={_in:(0,ef.Z)(d)}),n&&(l.accountId={_eq:n}),a&&(l.outstandingdays={_gte:a.split("-")[0]||null,_lte:a.split("-")[1]||null}),(u||i)&&(f=[{_and:[{_or:[{_and:[{createdAt:{_gte:i}},{createdAt:{_lte:u}}]}]}]}]),o&&(p=void 0!==s&&s?[{Invoices:{Job:{number:{_ilike:o}}}}]:[{_or:[{Invoices:{invoiceNumber:{_eq:o}}},{Invoices:{Job:{number:{_ilike:o}}}},{PaymentReconciliations:{InvoiceEntry:{Invoices:{invoiceNumber:{_eq:o}}}}},{PaymentReconciliations:{InvoiceEntry:{Invoices:{Job:{number:{_ilike:o}}}}}}]}]),(v.length>0||p.length>0||f.length>0)&&(m={_and:(0,ef.Z)(v).concat((0,ef.Z)(p),(0,ef.Z)(f))}),(0,R.Z)({},l,m)},eI=t(62047),ej=t(91272),eZ=t(20705),e_=t(13077);function ew(){var e=(0,I.Z)(["\n  background-color: ",";\n"]);return ew=function(){return e},e}var eC=function(e){var n=e.adminId,t=e.accountId,i=e.locationId,o=e.onSendEntities;e.toggleShow;var r=(0,c.useState)(!1),u=r[0],m=r[1],p=function(e,n){var t=e.id;J(B.map(function(e){return e.id===t&&(e.assigned=n),e}))},f=[{hidden:!0},{hidden:!0},{text:"Number",formatter:function(e){var n,t=e.row;return Q.YK.includes(t.type)?"PM ".concat(t.invoiceNumber):(0,a.jsx)(O.D,{id:t.jobId,number:t.number,invoiceNumber:null===(n=t.invoice)||void 0===n?void 0:n.invoiceNumber,type:t.jobType})}},{formatter:function(e){var n=e.row,t=e.row.itemType;return(0,a.jsx)(eT,{content:t,row:n,size:"sm"})},text:"Type"},{hidden:!0},{hidden:!0},{hidden:!0},{text:"Amount Outstanding",formatter:function(e){var n=e.row;return"invoice"===n.itemType||"proformaInvoice"===n.itemType?(0,v.Z)(n.outstandingAmount):"-"}},{text:"Status",formatter:function(e){var n=e.row;return n.status?(0,a.jsx)(e_.B,{value:n.status}):""}},{hidden:!0},{hidden:!0},{formatter:function(e){var n,t,i,o,r=e.row;return(0,a.jsx)(eI.Z,{context:"secondary",size:"sm",onToggle:function(e){return p(r,e)},toggled:r.assigned||(null===(n=r.meta)||void 0===n?void 0:n.xeroInvoiceId)||(null===(t=r.meta)||void 0===t?void 0:t.xeroCreditNoteId),disabled:(null===(i=r.meta)||void 0===i?void 0:i.xeroInvoiceId)||(null===(o=r.meta)||void 0===o?void 0:o.xeroCreditNoteId)})},text:(0,a.jsx)(eI.Z,{context:"secondary",size:"sm",onToggle:function(e){return h(e)}})}],h=function(e){J(W(e))},b=function(){m(!1)},x=function(e){e.preventDefault(),m(!0),o(B.filter(function(e){var n,t;return e.assigned&&!((null===(n=e.meta)||void 0===n?void 0:n.xeroInvoiceId)||(null===(t=e.meta)||void 0===t?void 0:t.xeroCreditNoteId))}).map(function(e){return"creditNote"===e.itemType?{id:e.id,entity:e.itemType}:{entity:e.itemType,invoiceType:e.invoice.invoiceType||null,invoiceId:e.id||null}}),b)},y=(0,d.useRouter)().query,g={endDate:y.endDate&&new Date(y.endDate),outstandingLevel:y.outstandingLevel,startDate:y.startDate&&new Date(y.startDate),type:["ppmInvoice","proformaInvoice","partial","paid","unpaid"]},I=(0,c.useState)(g)[0],j=I.endDate,Z=I.outstandingLevel,_=I.startDate,w=I.type,C=(0,eZ.x)({filters:I}),T=C.initialData,S=C.ref,A=(0,N.Z)((0,R.Z)({},T),{limit:25}),k=(0,s.a)(l.BH,{fetchPolicy:"no-cache",variables:(0,N.Z)((0,R.Z)({},A),{where:(0,N.Z)((0,R.Z)({},eg({outstandingLevel:Z,adminId:n,accountId:t,to:j,from:_,locationId:i,type:w})),{_or:[{_and:[{meta:{_is_null:!1}},{_not:{meta:{_has_key:"xeroInvoiceId"}}},{_not:{meta:{_has_key:"xeroCreditNoteId"}}}]},{meta:{_is_null:!0}}]}),locationId:i})}),D=k.data,P=void 0===D?{accountEntries:[],meta:{aggregate:{totalCount:0,debitTotal:{debit:0},creditTotal:{credit:0},balance:{balance:0}}}}:D,$=P.accountEntries,E=P.meta,F=k.loading,L=k.refetch,M=(0,c.useState)([]),B=M[0],J=M[1],W=(0,c.useCallback)(function(e){return $.map(function(n){var t,i,o,r,a,c,u,d,s,l,m,v,p,f,h;return{id:n.id,jobId:null==n?void 0:null===(t=n.invoices)||void 0===t?void 0:null===(i=t[0])||void 0===i?void 0:null===(o=i.Job)||void 0===o?void 0:o.id,number:null==n?void 0:null===(r=n.invoices)||void 0===r?void 0:null===(a=r[0])||void 0===a?void 0:null===(c=a.Job)||void 0===c?void 0:c.number,itemType:n.type,jobType:null==n?void 0:null===(u=n.invoices)||void 0===u?void 0:null===(d=u[0])||void 0===d?void 0:null===(s=d.Job)||void 0===s?void 0:s.type,invoiceNumber:null==n?void 0:null===(l=n.invoices)||void 0===l?void 0:null===(m=l[0])||void 0===m?void 0:m.invoiceNumber,invoice:(null==n?void 0:n.invoices)?null==n?void 0:null===(v=n.invoices)||void 0===v?void 0:v[0]:null,outstandingAmount:n.outstandingAmount,status:null==n?void 0:null===(p=n.invoices)||void 0===p?void 0:null===(f=p[0])||void 0===f?void 0:null===(h=f.Job)||void 0===h?void 0:h.status,paymentStatus:n.paymentStatus,meta:null==n?void 0:n.meta,assigned:e,actions:""}})},[$]);return(0,c.useEffect)(function(){J(W(!1))},[W,F]),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(et.Z,{sx:{color:"#fff",zIndex:function(e){return e.zIndex.drawer+1}},open:u,children:(0,a.jsx)(ei.Z,{color:"inherit"})}),(0,a.jsx)(q.Z,{id:"offCanvasForm",handleSubmit:x,children:(0,a.jsx)(ej.t,{columns:f,loading:F,meta:E,ref:S,refetch:L,rows:B,xeroPageSize:25})})]})};eC.propTypes={adminId:u.number.isRequired,accountId:u.number.isRequired,locationId:u.number,toggleShow:u.func,onSendEntities:u.func.isRequired};var eT=(0,j.ZP)(w.Z).withConfig({displayName:"syncXero__StyledBadge",componentId:"sc-75de2795-0"})(ew(),function(e){return(0,i.getColor)(e.row,e.theme)}),eR=t(86021),eN=t(80695),eS=t(36368),eA=t(14924),ek=t(96486),eD=function(e){var n,t,i,o=e.accountId,r=e.locationId,a=e.jobId,c=[];c.push(r?{locationId:{_eq:r}}:{}),c.push(o?{accountId:{_eq:o}}:{}),c.push(a?{Invoices:{entityId:{_eq:a}}}:{}),c.push({type:{_in:["proformaInvoice","customerPpmInvoice","supplierPpmInvoice","invoice"]},paymentStatus:{_in:["unpaid","partial"]}});var u=c.filter(function(e){return!ek.isEmpty(e)});return(0,R.Z)({},u.length>0&&{_and:u})},eq=t(87918),eP=t(86886),e$=t(50135),eE=t(33754),eF=t(87109),eL=t(72852),eM=t(50480),eB=t(70452),eJ=t(93946),eW=t(74231),eU=(0,eW.Ry)().shape({dateReceived:(0,eW.hT)().required("Date Received is required").typeError("Date Received is required"),amount:(0,eW.Rx)().min(0).required("Amount Received is required"),reason:(0,eW.Z_)().nullable()}),eX=function(e){var n,t,i,o,r=e.accountId,u=e.locationId,d=e.jobId,m=e.refetch,v=e.close,p=(0,ev.D)(),f=(0,el.q)(),h=null===(n=f.admin)||void 0===n?void 0:null===(t=n.jobSetting)||void 0===t?void 0:t.jobNumberPrefix,b=null===(i=f.admin)||void 0===i?void 0:null===(o=i.jobSetting)||void 0===o?void 0:o.jobNumberSuffix,x=(0,eZ.x)({filters:null}),y=x.initialData,g=x.ref,I=(0,c.useState)(null),j=I[0],Z=I[1],_=(0,c.useState)(null),w=_[0],C=_[1],T=(0,c.useState)(0),k=T[0],D=T[1],q=(0,c.useState)(""),P=q[0],$=q[1],E=(0,c.useState)(!1),F=E[0],L=E[1],B=(0,c.useState)([]),J=B[0],W=B[1],U=(0,c.useState)(0),X=U[0],Y=U[1],z=(0,c.useMemo)(function(){return eD({accountId:r,locationId:u,jobId:d})},[r,d,u]),V=(0,s.a)(l.v8,{variables:{limit:y.limit,offset:y.offset,accountId:r,locationId:u,orderBy:y.orderBy,where:z},onCompleted:function(e){var n,t=null==e?void 0:null===(n=e.accountEntries)||void 0===n?void 0:n.map(function(e,n){var t,i,o,r,a=null===(t=e.invoices)||void 0===t?void 0:t[0];return{index:n,id:e.id,type:e.type,jobId:null==a?void 0:null===(i=a.Job)||void 0===i?void 0:i.id,locationId:e.locationId,jobNumber:null==a?void 0:null===(o=a.Job)||void 0===o?void 0:o.number,jobType:null==a?void 0:null===(r=a.Job)||void 0===r?void 0:r.type,invoiceNumber:e.invoiceNumber,date:ec()(e.createdAt).format("YYYY-MM-DD"),daysOutstanding:e.outstandingdays,outstandingAmount:e.outstandingAmount,amount:0,invoiceId:null==a?void 0:a.id,meta:e.meta}});W(t||[])}}),Q=V.data,G=(void 0===Q?{meta:{aggregate:{totalCount:0,debitTotal:{debit:0},creditTotal:{credit:0}}}}:Q).meta,K=V.loading,H=V.refetch,ee=(0,S.Z)((0,A.D)(l.DI,{refetchQueries:["GetAccountEntries","GetJob"],onCompleted:function(){p.show({severity:"success",content:"Credit note was added successfully."}),m&&m(),v&&v()},onError:function(e){p.show({severity:"error",content:"Error: ".concat(e.message)})}}),2),er=ee[0],ea=ee[1].loading,ed=function(e){e.preventDefault();try{eU.validateSync({dateReceived:w,amount:k,reason:P},{abortEarly:!1})}catch(n){return Z(n.inner.reduce(function(e,n){var t=n.path,i=n.message;return(0,N.Z)((0,R.Z)({},e),(0,eA.Z)({},t,i))},{}))}if(Number(X).toFixed(2)!==Number(k).toFixed(2))return p.show({severity:"error",content:"Error: The sum of the reconciled amounts does not match the amount received."});er({variables:{data:{dateReceived:w,amountReceived:k,reason:P,accountId:r,payments:J.filter(function(e){return e.amount>0}).map(function(e){var n;return{id:e.id,amount:e.amount}})}}})},es=(0,c.useCallback)(function(e){var n=Number(e.target.value);D(function(){if(!F)return e.target.value;var t=n,i=0,o=J.map(function(e){var n=Math.min(e.outstandingAmount,t);return i+=(0,M.l)(n,2),t-=(0,M.l)(n,2),(0,N.Z)((0,R.Z)({},e),{amount:(0,M.l)(n,2)})});return Y((0,M.l)(i,2)),W(o),n})},[F,J]),em=(0,c.useCallback)(function(e,n){L(function(){if(!n)return n;var e=k,t=0,i=J.map(function(n){var i=Math.min(n.outstandingAmount,e);return t+=(0,M.l)(i,2),e-=(0,M.l)(i,2),(0,N.Z)((0,R.Z)({},n),{amount:(0,M.l)(i,2)})});return Y((0,M.l)(t,2)),W(i),n})},[k,J]),ep=(0,c.useCallback)(function(e,n){W(function(t){var i=0,o=t.map(function(t){return t.id===e?(i+=(0,M.l)(Number(n),2),(0,N.Z)((0,R.Z)({},t),{amount:n})):(i+=(0,M.l)(Number(t.amount),2),(0,R.Z)({},t))});return Y(i),o})},[W]),ef=(0,c.useMemo)(function(){return[{flex:1,minWidth:120,sortable:!1,headerName:"Number",field:"number",renderCell:function(e){var n=e.row;return["customerPpmInvoice","supplierPpmInvoice"].includes(n.type)?"PM ".concat(n.invoiceNumber):(0,a.jsx)(O.D,{id:n.jobId,number:n.jobNumber,invoiceNumber:n.invoiceNumber,numberPrefix:h,numberSuffix:b,openCanvas:!0,type:n.jobType})}},{flex:1,minWidth:120,sortable:!0,sortName:"createdAt",headerName:"Date",field:"date"},{flex:1,minWidth:120,sortable:!0,sortName:"outstandingdays",headerName:"Days Outstanding",field:"daysOutstanding"},{flex:1,minWidth:120,sortable:!0,sortName:"outstandingAmount",headerName:"Amount Outstanding",field:"outstandingAmount",renderCell:function(e){var n=e.row;return(0,eu.T)(n.outstandingAmount)}},{flex:1,minWidth:250,sortable:!1,headerName:"Reconciled Amount",field:"amount",renderCell:function(e){var n=e.row;return(0,a.jsxs)(en.Z,{direction:"row",children:[(0,a.jsx)(e$.Z,{fullWidth:!0,variant:"outlined",color:"secondary",size:"small",type:"number",value:n.amount,onChange:function(e){return ep(n.id,e.target.value)},inputProps:{min:0,step:.01},InputProps:{startAdornment:(0,a.jsx)(eF.Z,{position:"start",children:"\xa3"})}}),(0,a.jsx)(eJ.Z,{onClick:function(){return ep(n.id,n.outstandingAmount)},children:(0,a.jsx)(eB.Z,{})})]})}}]},[ep,h,b]);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(et.Z,{sx:{zIndex:1e5},open:ea,children:(0,a.jsx)(ei.Z,{color:"secondary"})}),(0,a.jsx)("form",{id:"offCanvasForm",onSubmit:ed,children:(0,a.jsxs)(en.Z,{width:"100%",children:[(0,a.jsxs)(eP.ZP,{container:!0,columnSpacing:2,rowSpacing:2,children:[(0,a.jsx)(eP.ZP,{item:!0,xs:6,children:(0,a.jsx)(eE.M,{value:w,onChange:function(e){return C(e)},label:"Date Received",renderInput:function(e){return(0,a.jsx)(e$.Z,(0,N.Z)((0,R.Z)({},e),{fullWidth:!0,variant:"outlined",color:"secondary",error:!!(null==j?void 0:j.dateReceived),helperText:null==j?void 0:j.dateReceived}))}})}),(0,a.jsx)(eP.ZP,{item:!0,xs:6,children:(0,a.jsx)(e$.Z,{fullWidth:!0,color:"secondary",type:"number",label:"Amount",value:k,onChange:es,inputProps:{min:0,step:.01},InputProps:{startAdornment:(0,a.jsx)(eF.Z,{position:"start",children:"\xa3"})},error:!!(null==j?void 0:j.amount),helperText:null==j?void 0:j.amount})}),(0,a.jsx)(eP.ZP,{item:!0,xs:12,children:(0,a.jsx)(e$.Z,{multiline:!0,rows:4,label:"Reason",variant:"filled",color:"secondary",value:P,onChange:function(e){return $(e.target.value)},sx:{width:"50%"},error:!!(null==j?void 0:j.reason),helperText:null==j?void 0:j.reason})}),(0,a.jsx)(eP.ZP,{item:!0,xs:6,children:(0,a.jsx)(eM.Z,{control:(0,a.jsx)(eL.Z,{checked:F,onChange:em,color:"success"}),label:"Auto Reconcile"})})]}),(0,a.jsx)(eo.i,{columns:ef,loading:K,history:!1,meta:G,ref:g,refetch:H,rows:J}),(0,a.jsx)(en.Z,{width:"100%",direction:"row",justifyContent:"flex-end",children:(0,a.jsx)(eq.Z,{label:"Sum: ".concat((0,eu.T)(X)),color:Number(X).toFixed(2)===Number(k).toFixed(2)?"success":"danger"})})]})})]})};eX.propTypes={type:(0,u.oneOf)(["customer","supplier"]).isRequired,accountId:u.number.isRequired,locationId:u.number,jobId:u.number,refetch:u.func.isRequired,close:u.func.isRequired};var eY=function(e){var n=e.itemType,t=e.paymentStatus;return"paymentReceipt"===n?"black":"creditNote"===n?"dark":"paid"===t?"success":"partial"===t?"pink":"warning"},ez=t(9492),eO=t(25771),eV=t(56063),eQ=t(64872),eG=t(5336),eK=t(67720),eH=function(e){var n=e.creditNote,t=e.paymentReceipt,i=e.proformaInvoice,o=e.unpaid,r=e.partiallyPaid,a=e.paid,c=[];return(n&&c.push("creditNote"),t&&c.push("paymentReceipt"),i&&c.push("proformaInvoice"),o&&c.push("unpaid"),r&&c.push("partial"),a&&c.push("paid"),0===c.length)?{}:{type:{_in:(0,ef.Z)(c).concat(["customerPpmInvoice","supplierPpmInvoice","invoice"])},paymentStatus:{_in:(0,ef.Z)(c)}}},e0=function(e){var n,t,i,o,r,a,c=e.accountId,u=e.locationId,d=e.startDate,s=e.endDate,l=e.invoiceNumber,m=e.outstandingLevel,v=e.type,p=[];p.push(u?{_or:[{locationId:{_eq:u}},{PaymentReconciliations:{locationId:{_eq:u}}}]}:{}),p.push(c?{accountId:{_eq:c}}:{}),p.push(eH(v)),p.push(m?{outstandingdays:{_gte:m.split("-")[0]||null,_lte:m.split("-")[1]||null}}:{}),p.push(d||s?{_and:[{_or:[{_and:[{createdAt:{_gte:d}},{createdAt:{_lte:s}}]}]}]}:{}),p.push(l?{_or:[{Invoices:{invoiceNumber:{_ilike:"%".concat(l,"%")}}},{Invoices:{Job:{number:{_ilike:"%".concat(l,"%")}}}},{PaymentReconciliations:{InvoiceEntry:{Invoices:{invoiceNumber:{_ilike:"%".concat(l,"%")}}}}},{PaymentReconciliations:{InvoiceEntry:{Invoices:{Job:{number:{_ilike:"%".concat(l,"%")}}}}}}]}:{});var f=p.filter(function(e){return!ek.isEmpty(e)});return(0,R.Z)({},f.length>0&&{_and:f})},e1=t(45082),e2=t(92321),e6=t(61730),e5=function(e){var n=e.control,t=e.setFilters,i=e.handleSubmit,o=(0,e6.Z)("(max-width:800px)"),r=function(e){t({startDate:e.startDate,endDate:e.endDate,invoiceNumber:e.invoiceNumber,outstandingLevel:e.outstandingLevel,creditNote:e.creditNote,paymentReceipt:e.paymentReceipt,proformaInvoice:e.proformaInvoice,unpaid:e.unpaid,partiallyPaid:e.partiallyPaid,paid:e.paid})};return(0,a.jsx)("form",{onSubmit:i(r),children:(0,a.jsxs)(en.Z,{width:"100%",spacing:1,children:[(0,a.jsxs)(en.Z,{direction:o?"column":"row",alignItems:"center",width:"100%",spacing:2,children:[(0,a.jsx)(D.Qr,{name:"startDate",control:n,render:function(e){return(0,a.jsx)(eE.M,(0,N.Z)((0,R.Z)({},e),{label:"Start date",renderInput:function(e){return(0,a.jsx)(e$.Z,(0,N.Z)((0,R.Z)({},e),{fullWidth:!0,variant:"outlined",color:"secondary"}))}}))}}),(0,a.jsx)(D.Qr,{name:"endDate",control:n,render:function(e){return(0,a.jsx)(eE.M,(0,N.Z)((0,R.Z)({},e),{label:"End date",renderInput:function(e){return(0,a.jsx)(e$.Z,(0,N.Z)((0,R.Z)({},e),{fullWidth:!0,variant:"outlined",color:"secondary"}))}}))}}),(0,a.jsx)(D.Qr,{name:"invoiceNumber",control:n,render:function(e){return(0,a.jsx)(e$.Z,(0,N.Z)((0,R.Z)({},e),{fullWidth:!0,label:"Id / Invoice",variant:"outlined",color:"secondary"}))}}),(0,a.jsx)(D.Qr,{name:"outstandingLevel",control:n,render:function(e){var n=e.value,t=e.onChange;return(0,a.jsx)(e2.P,{label:"Outstanding Level",value:n,onChange:t,options:e1.r,formControl:{fullWidth:!0,error:!1,helperText:""},selectProps:{fullWidth:!0,variant:"outlined",color:"secondary"}})}}),(0,a.jsx)(es.Z,{variant:"contained",color:"secondary",type:"submit",size:"medium",sx:{height:"36px",minWidth:"auto",width:"100%",maxWidth:"120px"},children:"Filter"})]}),(0,a.jsxs)(en.Z,{direction:"row",width:"100%",justifyContent:"space-between",flexWrap:"wrap",children:[(0,a.jsx)(eM.Z,{control:(0,a.jsx)(D.Qr,{name:"creditNote",control:n,render:function(e){var n=e.value,t=e.onChange;return(0,a.jsx)(eL.Z,{checked:n,onChange:function(e,n){return t(n)},color:"dark"})}}),label:"Credit Note"}),(0,a.jsx)(eM.Z,{control:(0,a.jsx)(D.Qr,{name:"paymentReceipt",control:n,render:function(e){var n=e.value,t=e.onChange;return(0,a.jsx)(eL.Z,{checked:n,onChange:function(e,n){return t(n)},color:"black"})}}),label:"Payment"}),(0,a.jsx)(eM.Z,{control:(0,a.jsx)(D.Qr,{name:"proformaInvoice",control:n,render:function(e){var n=e.value,t=e.onChange;return(0,a.jsx)(eL.Z,{checked:n,onChange:function(e,n){return t(n)},color:"danger"})}}),label:"Proforma Invoice"}),(0,a.jsx)(eM.Z,{control:(0,a.jsx)(D.Qr,{name:"unpaid",control:n,render:function(e){var n=e.value,t=e.onChange;return(0,a.jsx)(eL.Z,{checked:n,onChange:function(e,n){return t(n)},color:"danger"})}}),label:"Unpaid"}),(0,a.jsx)(eM.Z,{control:(0,a.jsx)(D.Qr,{name:"partiallyPaid",control:n,render:function(e){var n=e.value,t=e.onChange;return(0,a.jsx)(eL.Z,{checked:n,onChange:function(e,n){return t(n)},color:"pink"})}}),label:"Parially Paid"}),(0,a.jsx)(eM.Z,{control:(0,a.jsx)(D.Qr,{name:"paid",control:n,render:function(e){var n=e.value,t=e.onChange;return(0,a.jsx)(eL.Z,{checked:n,onChange:function(e,n){return t(n)},color:"success"})}}),label:"Paid"})]})]})})},e3=t(84193),e8=t(63139),e9=function(e){var n=e.xeroUserId,t=e.showXeroSyncButton,i=e.onClickXeroSync,o=e.showSyncEntriesWithXero,r=e.downloadCsv,c=e.csvDownloading;return(0,a.jsxs)(en.Z,{direction:"row",alignItems:"center",spacing:2,children:[!!n&&t&&(0,a.jsx)(es.Z,{varinat:"contained",color:"info",onClick:function(e){e.preventDefault(),e.stopPropagation(),i()},children:"Connect to Xero"}),!!n&&!t&&(0,a.jsx)(es.Z,{varinat:"contained",color:"info",onClick:function(e){e.preventDefault(),e.stopPropagation(),o()},children:"Send Account Entries to Xero"}),!(0,e8.s)()&&(0,a.jsx)(es.Z,{disabled:c,disableMinWidth:!0,variant:"contained",color:"success",onClick:function(e){e.stopPropagation(),r()},children:c?(0,a.jsx)(ei.Z,{size:30,color:"success"}):(0,a.jsx)(e3.Z,{})})]})},e7=t(2173),e4=function(e){var n,t,i,u,d,m,v,p=e.type,f=e.accountId,h=e.edit,b=e.locationId,x=e.xeroUserId,y=e.xeroCompanyId,g=e.showXeroSyncButton,I=e.onClickXeroSync,j=e.onSendEntitiesToXero,Z=(e.onSendPaymentToXero,e.onReceiveUpdatesFromXero),_=(0,e6.Z)("(max-width:600px)"),w=(0,c.useState)(!1),C=w[0],T=w[1],N=(0,eQ.a)(),A=(0,V.x)().user,k=(0,U.x)(),q=(0,el.q)(),P=A.adminId,$=null===(n=q.admin)||void 0===n?void 0:null===(t=n.jobSetting)||void 0===t?void 0:t.jobNumberPrefix,E=null===(i=q.admin)||void 0===i?void 0:null===(u=i.jobSetting)||void 0===u?void 0:u.jobNumberSuffix,F=(0,c.useState)({}),L=F[0],M=F[1],B=(0,eZ.x)({filters:L}),J=B.initialData,W=B.ref,Y=(0,D.cI)({defaultValues:(0,R.Z)({},ne)}),et=Y.control,ei=Y.handleSubmit,ea=Y.watch,ed=L.startDate,ev=L.endDate,ef=L.invoiceNumber,eh=L.outstandingLevel,eb=ea("creditNote"),ex=ea("paymentReceipt"),eg=ea("proformaInvoice"),eI=ea("unpaid"),ej=ea("partiallyPaid"),e_=ea("paid"),ew=(0,c.useMemo)(function(){return e0({accountId:f,locationId:b,startDate:ed,endDate:ev,invoiceNumber:ef,outstandingLevel:eh,type:{creditNote:eb,paymentReceipt:ex,proformaInvoice:eg,unpaid:eI,partiallyPaid:ej,paid:e_}})},[f,eb,ev,ef,b,eh,e_,ej,ex,eg,ed,eI]),eT=(0,s.a)(l.v8,{variables:{limit:J.limit,offset:J.offset,accountId:f,locationId:b,orderBy:J.orderBy,where:ew}}),eA=eT.data,ek=void 0===eA?{accountEntries:[],meta:{aggregate:{totalCount:0,debitTotal:{debit:0},creditTotal:{credit:0},balance:{balance:0}}}}:eA,eD=ek.accountEntries,eP=ek.meta,e$=eT.loading,eE=eT.refetch,eF=(0,S.Z)((0,X.t)(l.UA,{variables:{limit:null,offset:0,accountId:f,locationId:b,orderBy:J.orderBy,where:ew},onCompleted:function(e){var n=ey(e.accountEntries,{numberPrefix:$,numberSuffix:E}),t=z().unparse(n),i="data:application/octet-stream,"+encodeURIComponent(t);(0,ez.S)(i,"account-entries.csv")}}),2),eL=eF[0],eM=eF[1].loading,eB=eP.aggregate.debitTotal.debit,eJ=eP.aggregate.creditTotal.credit,eW=function(){N.show({content:(0,a.jsx)(eS.q,{type:p,accountId:f,locationId:b,refetch:eE,close:N.close}),title:"Add Payment Received",xs3:"100vw",sm:"100vw",sm2:"100vw",sm3:"80vw",md2:"80vw",lg:"80vw",lg2:"80vw"})},eU=function(){N.show({content:(0,a.jsx)(eX,{type:p,accountId:f,locationId:b,refetch:eE,close:N.close}),title:"Add credit note",xs3:"100vw",sm:"100vw",sm2:"100vw",sm3:"80vw",md2:"80vw",lg:"80vw",lg2:"80vw"})},eH=function(){N.show({content:(0,a.jsx)(eC,{accountId:f,locationId:b,adminId:P,toggleShow:N.close,onSendEntities:e2}),title:"Send Account Entries to Xero",xs3:"100vw",sm:"100vw",sm2:"100vw",sm3:"40vw",md2:"40vw",lg:"40vw",lg2:"40vw"})},e1=(0,c.useCallback)((d=(0,o.Z)(function(e,n){var t,i,o,a,c,u,d,s,l;return(0,r.__generator)(this,function(r){switch(r.label){case 0:switch(e.preventDefault(),e.stopPropagation(),i=void 0===(t=n.invoice)?{}:t,o=n.itemType){case"proformaInvoice":return[3,1];case"invoice":return[3,3];case"customerPpmInvoice":return[3,4];case"supplierPpmInvoice":return[3,6]}return[3,7];case 1:return[4,k.query({query:eO.WG,variables:{id:i.id}})];case 2:return d=r.sent().data.invoice,(0,eN.u)({meta:null==d?void 0:null===(a=d.accountEntry)||void 0===a?void 0:a.meta,invoice:d}),[3,8];case 3:return(0,eR._Z)({client:k,jobId:n.jobId,type:i.invoiceType}),[3,8];case 4:return[4,k.query({query:eO.Wj,variables:{accountEntryId:n.id}})];case 5:return l=r.sent().data.accountEntry,(0,eV.$)(l.meta),[3,8];case 6:return(0,e7.W)({client:k,accountEntryId:n.id}),[3,8];case 7:return[3,8];case 8:return[2]}})}),function(e,n){return d.apply(this,arguments)}),[k]),e2=(0,c.useCallback)((m=(0,o.Z)(function(e,n){return(0,r.__generator)(this,function(t){return T(!0),j({accountId:f,entities:e}).then(function(){eE(),T(!1),N.close(),n&&n()}),[2]})}),function(e,n){return m.apply(this,arguments)}),[f,N,j,eE]),e3=(0,c.useCallback)((v=(0,o.Z)(function(e,n){var t,i,o,a,c;return(0,r.__generator)(this,function(r){switch(r.label){case 0:return e.preventDefault(),e.stopPropagation(),t=n.id,i=n.itemType,a=void 0===(o=n.invoice)?[]:o,c=[],"creditNote"===i?c.push({entity:"creditNote",id:t}):c.push({entity:i,invoiceType:a.invoiceType||null,invoiceId:t||null}),[4,e2(c)];case 1:return r.sent(),[2]}})}),function(e,n){return v.apply(this,arguments)}),[e2]),e8=(0,c.useCallback)(function(e){var n,t,i,o,r=[{icon:"download",onClick:function(n){return e1(n,e)},tooltip:"Download",disabled:"creditNote"===e.itemType||"paymentReceipt"===e.itemType}];return x&&!((null===(n=e.meta)||void 0===n?void 0:n.xeroInvoiceId)||(null===(t=e.meta)||void 0===t?void 0:t.xeroCreditNoteId))&&"paymentReceipt"!==e.itemType&&"creditNote"!==e.itemType&&r.unshift({icon:"info",onClick:function(n){return e3(n,e)},tooltip:"Sync invoice with Xero",disabled:g||C}),x&&(null===(i=e.meta)||void 0===i?void 0:i.xeroInvoiceId)&&(r.unshift({icon:"check",tooltip:"Sync",disabled:!0}),(null===(o=e.meta)||void 0===o?void 0:o.syncedWithXero)||r.unshift({icon:"info",onClick:function(n){return Z(n,e)},tooltip:"Invoice has changes in Xero. Click to update it in Cleverly"})),r},[e1,C,Z,g,e3,x]),e4=(0,c.useMemo)(function(){return[{sortable:!1,flex:1,minWidth:180,headerName:"Type",field:"type",renderCell:function(e){var n=e.row;return(0,a.jsx)(eq.Z,{label:n.itemType,color:eY({itemType:n.itemType,paymentStatus:n.paymentStatus}),size:"small",sx:{borderRadius:1}})}},{sortable:!1,flex:1,minWidth:180,headerName:"Number",field:"number",renderCell:function(e){var n=e.row;return Q.YK.includes(n.itemType)?"PM ".concat(null==n?void 0:n.invoiceNumber):(0,a.jsx)(O.D,{id:n.jobId,number:n.number,invoiceNumber:null==n?void 0:n.invoiceNumber,numberPrefix:$,numberSuffix:E,openCanvas:!!n.jobId,type:n.jobType})}},{sortable:!1,flex:1,minWidth:180,headerName:"Reference",field:"reference"},{sortable:!1,flex:1,minWidth:180,headerName:"Date",field:"date"},{sortable:!1,flex:1,minWidth:120,headerName:"Days Outstanding",field:"outstandingDays"},{sortable:!1,flex:1,minWidth:120,headerName:"Amount Outstanding",field:"outstandingAmount",renderCell:function(e){var n=e.row;return"creditNote"===n.itemType||"paymentReceipt"===n.itemType?"-":(0,eu.T)(n.outstandingAmount)}},{sortable:!1,flex:1,minWidth:140,headerName:"Status",field:"status",renderCell:function(e){var n=e.row;return n.status?(0,a.jsx)(em.B,{value:n.status}):""}},{sortable:!1,flex:1,minWidth:120,headerName:"Debit",field:"debit",renderCell:function(e){var n=e.row;return n.debit?(0,eu.T)(n.debit):"-"}},{sortable:!1,flex:1,minWidth:120,headerName:"Credit",field:"credit",renderCell:function(e){var n=e.row;return n.credit?(0,eu.T)(n.credit):"-"}},{sortable:!1,flex:1,minWidth:120,headerName:"Balance",field:"balance",renderCell:function(e){var n=e.row;return(0,eu.T)(n.balance)}},{sortable:!1,minWidth:120,headerName:"Actions",field:"actions",renderCell:function(e){var n=e.row;return(0,a.jsx)(eG.C,{actionsData:e8,row:n})}}]},[e8,$,E]),nn=(0,c.useMemo)(function(){return eD.map(function(e){var n,t,i,o,r,a,c,u,d,s,l,m,v,p="creditNote"!==e.type&&"paymentReceipt"!==e.type?e.outstandingdays:"-",f=null===(n=e.invoices)||void 0===n?void 0:n[0];return{id:e.id,jobId:null==f?void 0:null===(t=f.Job)||void 0===t?void 0:t.id,jobIds:null===(i=e.invoices)||void 0===i?void 0:i.map(function(e){var n;return null==e?void 0:null===(n=e.job)||void 0===n?void 0:n.id}),number:null==f?void 0:null===(o=f.Job)||void 0===o?void 0:o.number,itemType:e.type,jobType:null==f?void 0:null===(r=f.Job)||void 0===r?void 0:r.type,invoiceNumber:e.invoiceNumber,invoice:f,reference:null===(a=e.meta)||void 0===a?void 0:a.reference,comment:null===(c=e.meta)||void 0===c?void 0:c.comment,date:ec()(e.createdAt).format("YYYY-MM-DD"),outstandingDays:p,service:null==f?void 0:null===(u=f.Job)||void 0===u?void 0:null===(d=u.service)||void 0===d?void 0:d.name,address:null==f?void 0:null===(s=f.Job)||void 0===s?void 0:null===(l=s.location)||void 0===l?void 0:l.name,outstandingAmount:e.outstandingAmount,status:null==f?void 0:null===(m=f.Job)||void 0===m?void 0:m.status,debit:e.debit,credit:e.credit,balance:e.balance,paid:null==f?void 0:null===(v=f.Job)||void 0===v?void 0:v.paid,paymentStatus:e.paymentStatus,entryId:e.entryId,meta:e.meta,actions:""}})},[eD]),nt=(0,c.useCallback)(function(e){var n=e.row;N.show({content:(0,a.jsx)(ep,{accountEntryId:n.id,close:N.close}),title:"Account Entry Details",xs3:"100vw",sm:"100vw",sm2:"100vw",sm3:"40vw",md2:"40vw",lg:"40vw",lg2:"40vw"})},[N]);return(0,a.jsxs)(G.Z,{defaultExpanded:!0,children:[(0,a.jsx)(H.Z,{expandIcon:(0,a.jsx)(er.Z,{}),children:(0,a.jsxs)(en.Z,{direction:"row",justifyContent:"space-between",width:"100%",pr:2,children:[(0,a.jsx)(ee.Z,{variant:"h6",children:"Account Entries"}),(0,a.jsx)(e9,{xeroUserId:x,xeroCompanyId:y,onClickXeroSync:I,showSyncEntriesWithXero:eH,downloadCsv:eL,csvDownloading:eM})]})}),(0,a.jsxs)(K.Z,{children:[(0,a.jsx)(e5,{control:et,setFilters:M,handleSubmit:ei}),(0,a.jsx)(eo.i,{ref:W,columns:e4,rows:nn,meta:eP,loading:e$,refetch:eE,onRowClick:nt,columnVisibilityModel:{outstandingDays:!h}}),(0,a.jsxs)(en.Z,{width:"100%",mt:2,spacing:2,children:[(0,a.jsxs)(en.Z,{direction:_?"column":"row",width:"100%",justifyContent:"flex-end",spacing:1,children:[(0,a.jsx)(eq.Z,{label:"Total Debit: ".concat((0,eu.T)(eB)),color:"info"}),(0,a.jsx)(eq.Z,{label:"Total Credit: ".concat((0,eu.T)(eJ)),color:"info"}),(0,a.jsx)(eq.Z,{label:"Balance: ".concat((0,eu.T)(eB-eJ)),color:"".concat(eB-eJ<0?"warning":"success")})]}),(0,a.jsx)(eK.Z,{}),(0,a.jsx)(en.Z,{width:"100%",direction:"row",justifyContent:"flex-end",spacing:2,children:h&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(es.Z,{variant:"contained",color:"secondary",onClick:eW,children:"Add Payment Received"}),"customer"===p&&(0,a.jsx)(es.Z,{variant:"contained",color:"secondary",onClick:eU,children:"Add Credit note"})]})})]})]})]})};e4.propTypes={type:(0,u.oneOf)(["customer","supplier"]).isRequired,accountId:u.number.isRequired,edit:u.bool,locationId:u.number,xeroUserId:u.string,xeroCompanyId:u.string,showXeroSyncButton:u.bool,onClickXeroSync:u.func,onSendEntitiesToXero:u.func},e4.defaultProps={edit:!0};var ne={startDate:null,endDate:null,invoiceNumber:"",outstandingLevel:null,creditNote:!0,paymentReceipt:!0,proformaInvoice:!0,unpaid:!0,partiallyPaid:!0,paid:!0},nn=t(99534),nt=t(79665),ni=t(32979),no=(0,eW.Ry)().shape({serviceRateType:(0,eW.Z_)().when("rateType",{is:"serviceRate",then:(0,eW.Z_)().oneOf(["grossPercent","costPlus"]).required("This field is required!")}),serviceRateLabour:(0,eW.Rx)().when("rateType",{is:"serviceRate",then:(0,eW.Rx)().min(0).required()}),serviceRateExpenses:(0,eW.Rx)().when("rateType",{is:"serviceRate",then:(0,eW.Rx)().min(0).required()}),arrangementFee:(0,eW.Rx)().when("rateType",{is:"rebate",then:(0,eW.Rx)().min(0).lessThan(100,"Rebate can`t be more than 99.99%").required()}),approvalThreshold:(0,eW.Rx)().min(0).required(),spendThreshold:(0,eW.Rx)().min(0).required(),invoiceDueDate:(0,eW.Rx)().min(0).required()}),nr=t(66321),na=t(9928),nc=t(21023),nu=t(48999),nd=t(5616),ns=t(10166),nl=function(e){var n,t=e.accountId,i=e.meta,c=e.refetch,u=e.toggleShow,d=(0,U.x)(),s=(0,R.Z)({},null==i?void 0:i.finance)||{},l=(0,D.cI)({defaultValues:{approvalThreshold:s.approvalThreshold||0,arrangementFee:s.arrangementFee||0,serviceRateLabour:s.serviceRateLabour||0,serviceRateExpenses:s.serviceRateExpenses||0,spendThreshold:s.spendThreshold||0,invoiceDueDate:s.invoiceDueDate||0,rateType:(s.serviceRateLabour||s.serviceRateExpenses)&&"serviceRate"||s.arrangementFee&&"rebate",serviceRateType:s.serviceRateType},resolver:(0,nt.S)(no)}),m=l.errors,v=l.handleSubmit,p=l.register,f=l.watch,h=l.control,b=(0,S.Z)((0,A.D)(k.Wn,{onCompleted:(0,o.Z)(function(){return(0,r.__generator)(this,function(e){switch(e.label){case 0:return[4,(0,na.j)({client:d,customerId:t})];case 1:return e.sent(),[2]}})})}),1)[0],x=(n=(0,o.Z)(function(e){return(0,r.__generator)(this,function(n){return b({variables:{customerId:t,customer:g(e),hasUpdateUser:!1,userId:t}}).then(function(){c(),u()}),[2]})}),function(e){return n.apply(this,arguments)}),y=f("rateType"),g=function(e){var n={};return n.meta=(0,R.Z)({},i)||{},n.meta.finance=s||{},"serviceRate"===y?(n.meta.finance.serviceRateType=e.serviceRateType,n.meta.finance.serviceRateLabour=e.serviceRateLabour,n.meta.finance.serviceRateExpenses=e.serviceRateExpenses,n.meta.finance.arrangementFee=0):"rebate"===y&&(n.meta.finance.serviceRateLabour=0,n.meta.finance.serviceRateExpenses=0,n.meta.finance.arrangementFee=e.arrangementFee),n.meta.finance.approvalThreshold=e.approvalThreshold,n.meta.finance.spendThreshold=e.spendThreshold,n.meta.finance.invoiceDueDate=e.invoiceDueDate,n},I={errors:m,register:p,type:"number"},j={direction:"row",sx:{"& .MuiTypography-root":{fontFamily:"Arial,sans-serif,sans-serif"}}},Z=function(e){return function(n){var t=n.children;return(0,a.jsx)(nm,{title:e,children:t})}};return(0,a.jsxs)(q.Z,{id:"offCanvasForm",handleSubmit:v(x),children:[(0,a.jsx)(nd.Z,{children:(0,a.jsx)(D.Qr,{name:"rateType",control:h,render:function(e){var n,t=e.value,i=e.onChange;return(0,a.jsx)(nr.E,{stackProps:j,formControlProps:{sx:{m:0}},value:t,onChange:i,options:[{label:"Service Rate",value:"serviceRate"},{label:"Rebate",value:"rebate"}],error:m.rateType,helperText:null===(n=m.rateType)||void 0===n?void 0:n.message})}})}),"serviceRate"===y&&(0,a.jsxs)(nd.Z,{children:[(0,a.jsx)(D.Qr,{name:"serviceRateType",control:h,render:function(e){var n,t=e.value,i=e.onChange;return(0,a.jsx)(nr.E,{stackProps:j,formControlProps:{sx:{m:0}},value:t,onChange:i,options:[{label:"% of Gross",value:"grossPercent",ParentComponent:Z("This will calculate your service rate as a % of the customer invoice e.g.\n                      if this is 5%, you will earn \xa35 on a \xa3100 customer invoice.")},{label:"Cost plus",value:"costPlus",ParentComponent:Z("Cost plus will add the percentage indicated to the supplier amount e.g.\n                      if this is 5% on a \xa3100 supplier invoice, customer invoice will be \xa3105.")}],error:m.serviceRateType,helperText:null===(n=m.serviceRateType)||void 0===n?void 0:n.message})}}),(0,a.jsxs)($.Z,{label:"Service Rate",children:[(0,a.jsx)(ni.Z,(0,N.Z)((0,R.Z)({},I),{label:"Labour",name:"serviceRateLabour"})),(0,a.jsx)(ni.Z,(0,N.Z)((0,R.Z)({},I),{label:"Expenses and Materials",name:"serviceRateExpenses"}))]})]}),"rebate"===y&&(0,a.jsx)(ni.Z,(0,N.Z)((0,R.Z)({},I),{label:"Rebate",name:"arrangementFee"})),(0,a.jsx)(P.Z,(0,N.Z)((0,R.Z)({},I),{label:"Approval Threshold",name:"approvalThreshold"})),(0,a.jsx)(P.Z,(0,N.Z)((0,R.Z)({},I),{label:"Spend Threshold",name:"spendThreshold"})),(0,a.jsx)($.Z,{label:"Invoice Due Date",children:(0,a.jsx)(E.Z,(0,N.Z)((0,R.Z)({},I),{name:"invoiceDueDate"}))})]})};nl.propTypes={meta:u.object,refetch:u.func.isRequired,toggleShow:u.func.isRequired};var nm=(0,ns.Z)(function(e){var n=e.className,t=(0,nn.Z)(e,["className"]);return(0,a.jsx)(nc.Z,(0,N.Z)((0,R.Z)({},t),{classes:{popper:n}}))})(function(e){var n=e.theme;return(0,eA.Z)({},"& .".concat(nu.Z.tooltip),{backgroundColor:n.palette.dark.main,boxShadow:n.shadows[1],fontSize:13})}),nv=t(51466),np=(0,eW.Ry)().shape({code:(0,eW.Z_)()}),nf=function(e){var n,t=e.onSuccess,i=e.meta,c=e.accountId,u={code:null==i?void 0:i.sageCode},d=(0,D.cI)({defaultValues:u,resolver:(0,nt.S)(np)}),s=d.control,l=d.errors,m=d.handleSubmit,v=d.register,p=(0,S.Z)((0,A.D)(k.Wn,{onCompleted:t}),2),f=p[0],h=p[1].error,b=(n=(0,o.Z)(function(e){var n,t;return(0,r.__generator)(this,function(o){return n=e.code,(t=(0,R.Z)({},i)||{}).sageCode=n,f({variables:{customerId:c,customer:{meta:t}}}),[2]})}),function(e){return n.apply(this,arguments)});return(0,a.jsxs)(q.Z,{id:"offCanvasForm",handleSubmit:m(b),children:[(0,a.jsx)($.Z,{label:"Sage Code",children:(0,a.jsx)(E.Z,(0,N.Z)((0,R.Z)({},{control:s,errors:l,register:v}),{name:"code"}))}),(0,a.jsx)(nv.Z,{children:null==h?void 0:h.message})]})};nf.propTypes={accountId:u.number.isRequired,meta:u.object,onSuccess:u.func.isRequired};var nh=t(41255),nb=function(e){var n,t,i=e.type,u=e.accountId,I=e.accountName,j=e.accountRefetch,Z=e.locationId,_=e.meta,w=e.hasSageIntegration,C=(0,c.useState)(!1),T=C[0],R=C[1],N=(0,d.useRouter)().query,S=(0,V.x)(),A=S.hasRole,k=S.user,D=(0,nh.RM)(null==k?void 0:k.id),q=(0,eQ.a)(),P=(0,c.useContext)(m.Z),$=A("admin"),E=(0,s.a)(l.Dn,{variables:{accountId:u}}),F=E.data,L=(void 0===F?{financial:{}}:F).financial,M=E.loading,B=E.refetch,W=(0,nh.BR)({adminId:k.id,xeroClientId:null==N?void 0:N.clientId,onSaveXeroTokenCallback:function(){return B()}},[k]),U=W.tokenStatus,X=W.onCallAuthorize,Y=W.onCallRefreshToken,z=W.onSendEntitiesToXero,O=W.onSendPaymentToXero,Q=W.onReceiveUpdatesFromXero;(0,c.useEffect)(function(){"unauthenticated"===U||"disconnected"===U?R(!0):R(!1)},[U]);var G=(null==_?void 0:_.finance)||{},K=L.bankAccounts,H=function(){P.close(),j()},ee=function(e){e.stopPropagation(),P.show({content:(0,a.jsx)(nf,{meta:_,onSuccess:H,accountId:u}),title:(null==_?void 0:_.sageCode)?"Add Sage Code":"Update Sage Code"})},en=function(e){e.stopPropagation(),q.show({content:(0,a.jsx)(nl,{accountId:u,meta:_,refetch:j,toggleShow:q.close}),title:"Edit Finance Details"})};if(M)return null;var et,ei,eo,er=function(){return(0,a.jsx)(p.Z,{children:(0,a.jsx)(f.Z,{context:"secondary",content:"Edit",onClick:en,size:"sm"})})},ea=function(){return(0,a.jsx)(p.Z,{children:(0,a.jsx)(f.Z,{context:"secondary",content:"Edit",onClick:ee,size:"sm"})})},ec=(et=(0,o.Z)(function(e,n){var t,i;return(0,r.__generator)(this,function(o){switch(o.label){case 0:return e.preventDefault(),e.stopPropagation(),[4,Q((null===(t=n.meta)||void 0===t?void 0:t.xeroInvoiceId)||(null===(i=n.meta)||void 0===i?void 0:i.xeroCreditNoteId),null==D?void 0:D.companyId,u)];case 1:return o.sent(),B(),[2]}})}),function(e,n){return et.apply(this,arguments)});return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(h.Z,{children:(0,a.jsx)(b.Z,{md:12,children:(0,a.jsx)(e4,{type:i,accountId:u,accountName:I,edit:$,locationId:Z,meta:_,xeroCompanyId:null==D?void 0:D.companyId,xeroUserId:null==D?void 0:D.clientId,refetchXeroToken:Y,showXeroSyncButton:T,onSendEntitiesToXero:z,onClickXeroSync:function(){return X(window.location.href)},onSendPaymentToXero:O,onReceiveUpdatesFromXero:ec})})}),A("admin")&&(0,a.jsxs)(h.Z,{children:[(0,a.jsxs)(b.Z,{md:"customer"===i?6:12,children:["customer"===i&&(0,a.jsx)(x.Z,{toolbar:$&&(0,a.jsx)(er,{}),title:"Overview",open:!0,children:(0,a.jsx)(y.Z,{rows:[{key:"Service Rate Labour",value:"".concat(G.serviceRateLabour||0,"%")},{key:"Service Rate Expenses and Materials",value:"".concat(G.serviceRateExpenses||0,"%")},{key:"Rebate",value:"".concat((null==G?void 0:G.arrangementFee)||0,"%")},{key:"Approval Threshold",value:(0,v.Z)(null!==(n=null==G?void 0:G.approvalThreshold)&&void 0!==n?n:0)},{key:"Spend Threshold",value:(0,v.Z)(null!==(t=null==G?void 0:G.spendThreshold)&&void 0!==t?t:0)},{key:"Stripe ID",value:G.stripeId||"-"},{key:"Invoice Due Date",value:G.invoiceDueDate||"-"}]})}),(0,a.jsx)(g.y,{accountId:u,data:K,edit:$,refetch:j}),"customer"===i&&(0,a.jsx)(x.Z,{toolbar:(0,a.jsx)(ea,{}),title:"Integration",open:!0,children:(0,a.jsx)(y.Z,{rows:(eo=[],w&&eo.push({key:"Sage Code",value:(null==_?void 0:null===(ei=_.sageCode)||void 0===ei?void 0:ei.length)>0?null==_?void 0:_.sageCode:"not set"}),eo)})})]}),(0,a.jsxs)(b.Z,{md:6,children:["customer"===i&&(0,a.jsx)(x.Z,{title:"Balance",open:!0,children:(0,a.jsx)(y.Z,{rows:[{key:"Total Outstanding",value:(0,v.Z)(G.amountOutstanding||0)},{key:"Total Revenues",value:(0,v.Z)(G.totalRevenue||0)}]})}),"customer"===i&&(0,a.jsx)(J,{accountId:u,edit:$,meta:_,offCanvas:q,refetch:j,customerBalance:0})]})]})]})};nb.propTypes={type:(0,u.oneOf)(["customer","supplier"]).isRequired,accountId:u.number.isRequired,accountName:u.string.isRequired,accountRefetch:u.func.isRequired,locationId:u.number.isRequired,meta:u.object.isRequired}},55862:function(e,n,t){t.d(n,{J:function(){return j}});var i=t(26042),o=t(69396),r=t(99534),a=t(828),c=t(85893),u=t(11163),d=t(67294),s=t(45697),l=t(9270),m=t(62140),v=t(42283),p=t(76600),f=t(11585),h=t(49501),b=t(75903),x=t(77439),y=t(25742),g=t(59938),I=function(e){var n=e.initialValues,t=e.renderFilters,r=e.setFilters,u=e.lastQuery,s=e.filters,I=(0,a.Z)((0,g.X)("form_data_".concat(n.filterType),n),2),j=I[0],Z=I[1],_=(0,v.cI)({defaultValues:j||n}),w=_.control,C=_.errors,T=_.handleSubmit,R=_.register,N=_.reset,S=_.watch,A=_.setValue,k=S(),D=(0,o.Z)((0,i.Z)({},k),{filterType:n.filterType});(0,d.useEffect)(function(){N(D)},[N]),(0,d.useEffect)(function(){Z(D)},[s]);var q=function(e){var t=e.query;if(t!==u){var o={q:"%".concat(t,"%")||0},a=/^\d+$/.test(t);"id"in n&&(o.id=a?Number(t):null),"meta"in n&&(o.meta=a?{invoiceNumbers:[t]}:null),"jobNumber"in n&&(o.jobNumber=a?String(t):null,o.invoiceNumber=a?Number(t):null),r(function(e){return(0,i.Z)({},e,o)})}},P=function(e){Object.keys(n).map(function(e){return A(e,null)}),r(n),N(n),q("")};return(0,c.jsx)(p.Z,{handleSubmit:T(q),children:(0,c.jsxs)(f.Z,{title:"Filters",children:[(0,c.jsxs)(l.Z,{children:[(0,c.jsx)(m.Z,{sm:12,lg:12,children:(0,c.jsx)(h.Z,{label:"",children:(0,c.jsx)(b.Z,{errors:C,label:"Search",name:"email",placeholder:"Search...",prependSearchIcon:!0,register:R,type:"search"})})}),(0,c.jsx)(m.Z,{sm:12,lg:12,children:t({control:w,errors:C,initialValues:n,register:R,setFilters:r,watch:S,setValue:A,reset:N})})]}),(0,c.jsx)(y.H,{content:"Search",context:"secondary",handleClick:q,type:"submit",children:(0,c.jsx)(x.Z,{content:"Clear",context:"danger",onClick:P,size:"sm"})})]})})};I.propTypes={initialValues:s.object,renderFilters:s.func.isRequired,setFilters:s.func.isRequired};var j=function(e){var n=e.FiltersComp,t=e.initialFilters,s=e.TableComp,v=(0,r.Z)(e,["FiltersComp","initialFilters","TableComp"]),p=(0,a.Z)((0,g.X)("form_data_".concat(t.filterType),t),2),f=p[0],h=p[1],b=(0,d.useState)(f||t),x=b[0],y=b[1],j=(0,u.useRouter)().query.show;return(0,d.useEffect)(function(){h(x)},[x,h]),(0,c.jsx)(l.Z,{children:(0,c.jsxs)(m.Z,{sm:12,lg:12,children:[(0,c.jsx)(I,{initialValues:t,renderFilters:function(e){return(0,c.jsx)(n,(0,o.Z)((0,i.Z)({},e,v),{show:j}))},setFilters:y,filters:x}),(0,c.jsx)(s,(0,i.Z)({filters:x,initialFilters:t},v))]})})};j.propTypes={FiltersComp:s.func,initialFilters:s.object.isRequired,TableComp:s.func}}}]);